<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador Simple de Rutas</title>
    
    <!-- Estilos -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 0.5rem;
        }
        .route-marker-start {
            color: green;
            font-size: 24px;
        }
        .route-marker-end {
            color: red;
            font-size: 24px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="container mx-auto">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold mb-6">Visualizador Simple de Rutas</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">ID del Dispositivo</span>
                    </label>
                    <input type="number" id="deviceId" class="input input-bordered" value="257">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Desde (YYYY-MM-DD)</span>
                    </label>
                    <input type="date" id="fromDate" class="input input-bordered">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Hasta (YYYY-MM-DD)</span>
                    </label>
                    <input type="date" id="toDate" class="input input-bordered">
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-6">
                <button id="btnToday" class="btn btn-sm btn-outline">Hoy</button>
                <button id="btnYesterday" class="btn btn-sm btn-outline">Ayer</button>
                <button id="btnLastWeek" class="btn btn-sm btn-outline">Última Semana</button>
                <button id="btnLastMonth" class="btn btn-sm btn-outline">Último Mes</button>
                <button id="btnGetRoute" class="btn btn-sm btn-primary ml-auto">Obtener Ruta</button>
            </div>
            
            <div class="mb-6">
                <div id="map"></div>
            </div>
            
            <div id="routeInfo" class="alert hidden mb-6"></div>
            
            <div class="flex justify-between">
                <a href="map.php" class="btn btn-outline">Volver al Mapa</a>
                <div class="flex gap-2">
                    <select id="methodSelect" class="select select-bordered">
                        <option value="all">Todos los métodos</option>
                        <option value="api">API Directa</option>
                        <option value="curl">CURL</option>
                        <option value="file">file_get_contents</option>
                    </select>
                    <button id="btnClearRoute" class="btn btn-error">Limpiar Ruta</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Inicializar mapa
        const map = L.map('map').setView([-12.046374, -77.042793], 10);
        
        // Añadir capa base
        L.tileLayer('https://{s}-tiles.locationiq.com/v3/streets/r/{z}/{x}/{y}.png?key=pk.e63c15fb2d66e143a9ffe1a1e9596fb5', {
            attribution: '&copy; <a href="https://locationiq.com">LocationIQ</a> | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: ['a', 'b', 'c'],
            maxZoom: 19
        }).addTo(map);
        
        // Variables globales
        let routeLine = null;
        let startMarker = null;
        let endMarker = null;
        
        // Elementos del DOM
        const deviceIdInput = document.getElementById('deviceId');
        const fromDateInput = document.getElementById('fromDate');
        const toDateInput = document.getElementById('toDate');
        const btnGetRoute = document.getElementById('btnGetRoute');
        const btnClearRoute = document.getElementById('btnClearRoute');
        const routeInfo = document.getElementById('routeInfo');
        const methodSelect = document.getElementById('methodSelect');
        
        // Botones de fechas predefinidas
        const btnToday = document.getElementById('btnToday');
        const btnYesterday = document.getElementById('btnYesterday');
        const btnLastWeek = document.getElementById('btnLastWeek');
        const btnLastMonth = document.getElementById('btnLastMonth');
        
        // Establecer fechas por defecto
        const today = new Date();
        const formatDate = (date) => {
            return date.toISOString().split('T')[0];
        };
        
        // Establecer fecha de hoy
        fromDateInput.value = formatDate(today);
        toDateInput.value = formatDate(today);
        
        // Función para mostrar información
        function showInfo(message, type = 'info') {
            routeInfo.textContent = message;
            routeInfo.className = `alert alert-${type}`;
            routeInfo.classList.remove('hidden');
        }
        
        // Función para limpiar la ruta
        function clearRoute() {
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
            
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
            }
            
            if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
            }
            
            routeInfo.classList.add('hidden');
        }
        
        // Función para obtener la ruta
        function getRoute() {
            // Limpiar ruta anterior
            clearRoute();
            
            // Obtener valores
            const deviceId = deviceIdInput.value;
            const fromDate = fromDateInput.value;
            const toDate = toDateInput.value;
            const method = methodSelect.value;
            
            // Validar valores
            if (!deviceId || !fromDate || !toDate) {
                showInfo('Por favor, complete todos los campos', 'warning');
                return;
            }
            
            // Mostrar mensaje de carga
            showInfo('Cargando ruta...', 'info');
            
            // Construir URL
            const url = `get_route_data.php?deviceId=${deviceId}&from=${fromDate}&to=${toDate}&method=${method}`;
            
            // Realizar solicitud
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.length > 0) {
                        // Mostrar ruta
                        showRoute(data.data);
                        showInfo(`Ruta cargada con éxito: ${data.count} puntos (Método: ${data.method})`, 'success');
                    } else {
                        // Mostrar error
                        showInfo(`Error: ${data.error || 'No se encontraron datos de ruta'}`, 'error');
                    }
                })
                .catch(error => {
                    showInfo(`Error: ${error.message}`, 'error');
                    console.error('Error al obtener ruta:', error);
                });
        }
        
        // Función para mostrar la ruta en el mapa
        function showRoute(routeData) {
            // Crear array de puntos
            const routePoints = routeData.map(point => [point.latitude, point.longitude]);
            
            // Crear línea de ruta
            routeLine = L.polyline(routePoints, {
                color: 'blue',
                weight: 3,
                opacity: 0.7
            }).addTo(map);
            
            // Añadir marcadores de inicio y fin
            const startPoint = routePoints[0];
            const endPoint = routePoints[routePoints.length - 1];
            
            // Marcador de inicio
            const startIcon = L.divIcon({
                html: '<div class="route-marker-start">●</div>',
                className: '',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            // Marcador de fin
            const endIcon = L.divIcon({
                html: '<div class="route-marker-end">●</div>',
                className: '',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            // Añadir marcadores al mapa
            startMarker = L.marker(startPoint, { icon: startIcon }).addTo(map);
            endMarker = L.marker(endPoint, { icon: endIcon }).addTo(map);
            
            // Añadir popups a los marcadores
            const startTime = new Date(routeData[0].deviceTime).toLocaleString();
            const endTime = new Date(routeData[routeData.length - 1].deviceTime).toLocaleString();
            
            startMarker.bindPopup(`<b>Inicio</b><br>Hora: ${startTime}`);
            endMarker.bindPopup(`<b>Fin</b><br>Hora: ${endTime}`);
            
            // Ajustar vista del mapa para mostrar toda la ruta
            map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
            
            // Mostrar información en consola
            console.log('Ruta cargada con éxito');
            console.log('Puntos:', routePoints.length);
            console.log('Inicio:', startTime);
            console.log('Fin:', endTime);
        }
        
        // Eventos
        btnGetRoute.addEventListener('click', getRoute);
        btnClearRoute.addEventListener('click', clearRoute);
        
        // Eventos para fechas predefinidas
        btnToday.addEventListener('click', () => {
            const today = new Date();
            fromDateInput.value = formatDate(today);
            toDateInput.value = formatDate(today);
        });
        
        btnYesterday.addEventListener('click', () => {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            fromDateInput.value = formatDate(yesterday);
            toDateInput.value = formatDate(yesterday);
        });
        
        btnLastWeek.addEventListener('click', () => {
            const today = new Date();
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            fromDateInput.value = formatDate(lastWeek);
            toDateInput.value = formatDate(today);
        });
        
        btnLastMonth.addEventListener('click', () => {
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setDate(lastMonth.getDate() - 30);
            fromDateInput.value = formatDate(lastMonth);
            toDateInput.value = formatDate(today);
        });
    </script>
</body>
</html>
